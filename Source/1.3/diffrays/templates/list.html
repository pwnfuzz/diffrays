{% extends "base.html" %}

{% block content %}
<h3 style="margin: 0 0 8px 0;">{{ title }}</h3>
<table class="list-table" id="listTable">
  <thead>
    <tr>
      <th style="width:30%;">
        <div style="display:flex; gap:8px; align-items:center;">
          <span class="sort-btn" onclick="sortByName()">Function ⬍</span>
          <input id="searchInput" class="input" type="text" placeholder="Search…" oninput="debouncedFilterRows()" />
        </div>
      </th>
      {% if show_diff_columns or show_signature_only %}
      <th>Address (Old)</th>
      <th>Address (New)</th>
      {% if show_diff_columns %}
      <th title="Basic Blocks">Blocks (Old)</th>
      <th title="Basic Blocks">Blocks (New)</th>
      {% endif %}
      {% endif %}
      {% if show_score %}
      <th id="scoreHeader" style="cursor:pointer;" onclick="toggleScoreSort()" title="Normal ratio (difflib SequenceMatcher): Measures textual similarity of pseudocode, but can be noisy due to IDA’s formatting or renaming.">
        <span>Ratio <span id="scoreArrow">↓</span></span>
        <span style="display:inline-block; width:6px; height:6px; border-radius:50%; background: var(--muted); opacity:.7; margin-left:6px; vertical-align:middle;" aria-hidden="true"></span>
      </th>
      <th id="smartRatioHeader" style="cursor:pointer;" onclick="toggleSmartRatioSort()" title="Smart ratio (with block counts): Incorporates structural changes in basic blocks, reducing false positives and better surfacing significant differences.">
        <span>S. Ratio <span id="smartRatioArrow">↓</span></span>
        <span style="display:inline-block; width:6px; height:6px; border-radius:50%; background: var(--muted); opacity:.7; margin-left:6px; vertical-align:middle;" aria-hidden="true"></span>
      </th>
      {% endif %}
      {% if show_version %}
      <th>Version</th>
      {% endif %}
      {% if show_diff_columns or show_signature_only %}
      <th>Signature</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for it in items %}
    <tr>
      <td style="word-break: break-all; max-width: 300px;">
        {% if open_raw %}
        <a href="{{ url_for('raw_view', name=it.name) }}?version={{ it.version }}{% if current_tab %}&from={{ current_tab }}{% endif %}">{{ it.name }}</a>
        {% else %}
        <a href="{{ url_for('function_view', name=it.name) }}">{{ it.name }}</a>
        {% endif %}
      </td>
      {% if show_diff_columns or show_signature_only %}
      <td><code>{{ it.old_addr and ('0x%X' % it.old_addr) or '-' }}</code></td>
      <td><code>{{ it.new_addr and ('0x%X' % it.new_addr) or '-' }}</code></td>
      {% if show_diff_columns %}
      <td>{{ it.old_blocks is not none and it.old_blocks or '-' }}</td>
      <td>{{ it.new_blocks is not none and it.new_blocks or '-' }}</td>
      {% endif %}
      {% endif %}
      {% if show_score %}
      <td data-score="{{ '%.6f'|format(it.score) }}">{{ '%.3f'|format(it.score) }}</td>
      <td data-smart-ratio="{{ '%.6f'|format(it.smart_ratio) }}">{{ '%.3f'|format(it.smart_ratio) }}</td>
      {% endif %}
      {% if show_version %}
      <td>{{ it.version }}</td>
      {% endif %}
      {% if show_diff_columns or show_signature_only %}
      <td>
        {% if it.signature %}
        <details>
          <summary>View</summary>
          <pre style="margin:6px 0; white-space:pre-wrap; max-height:200px; overflow-y:auto; font-size:12px;">{{ it.signature }}</pre>
        </details>
        {% else %}-{% endif %}
      </td>
      {% endif %}
    </tr>
    {% endfor %}
  </tbody>
  {% if not items %}
  <tbody><tr><td colspan="100%" class="empty">No items.</td></tr></tbody>
  {% endif %}
  </table>

  {% if pagination %}
  <div class="pagination">
    <div class="pagination-info">
      Showing {{ ((pagination.current_page - 1) * pagination.per_page) + 1 }} to {{ pagination.current_page * pagination.per_page if pagination.current_page * pagination.per_page < pagination.total_count else pagination.total_count }} of {{ pagination.total_count }} functions
    </div>
    <div class="pagination-controls">
      {% if pagination.has_prev %}
        <a href="{{ url_for(request.endpoint, page=pagination.prev_page) }}" class="btn secondary">← Previous</a>
      {% endif %}
      
      <div class="pagination-pages">
        {% for page_num in range(pagination.page_range_start, pagination.page_range_end) %}
          {% if page_num == pagination.current_page %}
            <span class="btn" style="background: var(--accent);">{{ page_num }}</span>
          {% else %}
            <a href="{{ url_for(request.endpoint, page=page_num) }}" class="btn secondary">{{ page_num }}</a>
          {% endif %}
        {% endfor %}
      </div>
      
      {% if pagination.has_next %}
        <a href="{{ url_for(request.endpoint, page=pagination.next_page) }}" class="btn secondary">Next →</a>
      {% endif %}
    </div>
  </div>
  {% endif %}

<script>
  let scoreAsc = false;
  let smartRatioAsc = false;
  let filterTimeout = null;
  
  function filterRows(){
    const q = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#listTable tbody tr');
    rows.forEach(r => {
      const name = r.children[0].innerText.toLowerCase();
      r.style.display = name.includes(q) ? '' : 'none';
    });
  }
  
  function debouncedFilterRows(){
    if (filterTimeout) {
      clearTimeout(filterTimeout);
    }
    filterTimeout = setTimeout(filterRows, 150); // 150ms debounce
  }
  
  // Optimize signature details loading
  document.addEventListener('DOMContentLoaded', function() {
    const detailsElements = document.querySelectorAll('details');
    detailsElements.forEach(details => {
      details.addEventListener('toggle', function() {
        if (this.open) {
          // Add a small delay to prevent blocking the UI
          setTimeout(() => {
            const pre = this.querySelector('pre');
            if (pre && pre.textContent.length > 1000) {
              pre.style.maxHeight = '200px';
              pre.style.overflowY = 'auto';
            }
          }, 10);
        }
      });
    });
  });
  function toggleScoreSort(){
    scoreAsc = !scoreAsc;
    const arrow = document.getElementById('scoreArrow');
    if (arrow) arrow.textContent = (scoreAsc ? '↑' : '↓');
    const tbody = document.querySelector('#listTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    // Determine the column index of the Ratio cell (the th with id=scoreHeader)
    const theadCells = Array.from(document.querySelectorAll('#listTable thead th'));
    let scoreIdx = theadCells.findIndex(th => th.id === 'scoreHeader');
    if (scoreIdx < 0) scoreIdx = 1; // fallback
    rows.sort((a,b)=>{
      const sa = parseFloat(a.children[scoreIdx]?.getAttribute('data-score')) || 0;
      const sb = parseFloat(b.children[scoreIdx]?.getAttribute('data-score')) || 0;
      return scoreAsc ? sa - sb : sb - sa;
    });
    rows.forEach(r=>tbody.appendChild(r));
  }
  function toggleSmartRatioSort(){
    smartRatioAsc = !smartRatioAsc;
    const arrow = document.getElementById('smartRatioArrow');
    if (arrow) arrow.textContent = (smartRatioAsc ? '↑' : '↓');
    const tbody = document.querySelector('#listTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    // Determine the column index of the S. Ratio cell (the th with id=smartRatioHeader)
    const theadCells = Array.from(document.querySelectorAll('#listTable thead th'));
    let smartRatioIdx = theadCells.findIndex(th => th.id === 'smartRatioHeader');
    if (smartRatioIdx < 0) smartRatioIdx = 2; // fallback
    rows.sort((a,b)=>{
      const sa = parseFloat(a.children[smartRatioIdx]?.getAttribute('data-smart-ratio')) || 0;
      const sb = parseFloat(b.children[smartRatioIdx]?.getAttribute('data-smart-ratio')) || 0;
      return smartRatioAsc ? sa - sb : sb - sa;
    });
    rows.forEach(r=>tbody.appendChild(r));
  }
  function sortByName(){
    const tbody = document.querySelector('#listTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort((a,b)=> a.children[0].innerText.localeCompare(b.children[0].innerText));
    rows.forEach(r=>tbody.appendChild(r));
  }
</script>
{% endblock %}


